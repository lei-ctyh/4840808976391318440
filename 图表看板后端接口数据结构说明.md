# 成绩对比后端接口数据结构说明

## 接口概述

成绩对比需要一个后端接口来获取考核数据，用于展示：
1. 当前单位的综合成绩和评级
2. 下级单位成绩对比
3. 年度趋势分析
4. 四级评价占比统计

---

## 请求参数

### 接口路径建议
```
GET /api/assessment/dashboard/statistics
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| orgCode | String | 是 | 组织/单位编码 | "ORG001" |
| year | String | 是 | 查询年度 | "2025" |

---

## 响应数据结构

### 完整数据结构

```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "currentMetrics": {
      "avgScore": 85.6,
      "excellentRate": 0.25,
      "goodRate": 0.55,
      "passRate": 0.92
    },
    "childrenComparisons": [
      {
        "name": "第一教学组织",
        "avgScore": 88.5,
        "excellentRate": 0.30,
        "goodRate": 0.60,
        "passRate": 0.95
      },
      {
        "name": "第二教学组织",
        "avgScore": 82.3,
        "excellentRate": 0.22,
        "goodRate": 0.52,
        "passRate": 0.88
      }
      // ... 更多下级单位（建议最多返回8个）
    ],
    "yearlyTrend": {
      "years": ["2021", "2022", "2023", "2024", "2025"],
      "avgScores": [78.5, 80.2, 82.1, 84.3, 85.6],
      "excellentRates": [18.5, 20.3, 22.1, 24.0, 25.0],
      "goodRates": [48.2, 50.5, 52.8, 54.2, 55.0],
      "passRates": [88.5, 89.8, 90.5, 91.2, 92.0],
      "failRates": [11.5, 10.2, 9.5, 8.8, 8.0]
    }
  }
}
```

---

## 数据字段详细说明

### 1. currentMetrics - 当前单位指标

当前选中单位在指定年度的考核指标汇总。

| 字段名 | 类型 | 说明 | 取值范围 | 示例 |
|--------|------|------|----------|------|
| avgScore | Number | 综合成绩（平均分） | 0-100 | 85.6 |
| excellentRate | Number | 优秀率（小数形式） | 0-1 | 0.25（表示25%） |
| goodRate | Number | 良好率（小数形式，累计） | 0-1 | 0.55（表示55%，包含优秀） |
| passRate | Number | 及格率（小数形式，累计） | 0-1 | 0.92（表示92%，包含优秀+良好） |

**重要说明**：
- `excellentRate`、`goodRate`、`passRate` 是**累计比例**
- 未及格率 = `1 - passRate`
- 实际良好占比 = `goodRate - excellentRate`
- 实际及格占比 = `passRate - goodRate`

**评级标准**（用于计算"综合评定"）：
- 优秀：avgScore >= 90
- 良好：80 <= avgScore < 90
- 及格：60 <= avgScore < 80
- 未及格：avgScore < 60

---

### 2. childrenComparisons - 下级单位对比数据

当前单位的所有**直接下级单位**在指定年度的考核数据，用于生成对比图表。

**数组元素结构**：

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| name | String | 下级单位名称 | "第一教学组织" |
| avgScore | Number | 该单位综合成绩 | 88.5 |
| excellentRate | Number | 该单位优秀率（小数） | 0.30 |
| goodRate | Number | 该单位良好率（小数，累计） | 0.60 |
| passRate | Number | 该单位及格率（小数，累计） | 0.95 |

**注意事项**：
- 如果当前单位没有下级单位，返回空数组 `[]`
- 建议最多返回 **8个** 下级单位（前端会自动处理，但数据过多会导致图表拥挤）
- 可按 `avgScore` 降序或按单位名称排序

**使用场景**：
- 下级单位成绩对比柱状图
- 下级单位四级评价对比柱状图

---

### 3. yearlyTrend - 年度趋势数据

当前单位在**最近5年**的考核趋势数据，用于生成趋势折线图。

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| years | String[] | 年份数组（5个元素） | ["2021", "2022", "2023", "2024", "2025"] |
| avgScores | Number[] | 对应年份的综合成绩 | [78.5, 80.2, 82.1, 84.3, 85.6] |
| excellentRates | Number[] | 对应年份的优秀率（**百分比形式**） | [18.5, 20.3, 22.1, 24.0, 25.0] |
| goodRates | Number[] | 对应年份的良好率（**百分比形式，累计**） | [48.2, 50.5, 52.8, 54.2, 55.0] |
| passRates | Number[] | 对应年份的及格率（**百分比形式，累计**） | [88.5, 89.8, 90.5, 91.2, 92.0] |
| failRates | Number[] | 对应年份的未及格率（**百分比形式**） | [11.5, 10.2, 9.5, 8.8, 8.0] |

**重要说明**：
- 年份数组应该是**连续的5年**，最新年份为请求参数中的 `year`
  - 例如：请求 `year=2025`，返回 `["2021", "2022", "2023", "2024", "2025"]`
- `excellentRates`、`goodRates`、`passRates`、`failRates` 使用**百分比数值**（0-100），而不是小数
  - 例如：25% 表示为 `25.0`，而不是 `0.25`
- 所有数组的长度必须一致（都是5个元素）
- 如果某年没有数据，可以用 `0` 或 `null` 填充（前端会处理）

**数据关系**：
- `failRates[i] = 100 - passRates[i]`
- 实际良好占比 = `goodRates[i] - excellentRates[i]`
- 实际及格占比 = `passRates[i] - goodRates[i]`

---

## 完整示例数据

### 示例1：有下级单位的情况

**请求**：
```
GET /api/assessment/dashboard/statistics?orgCode=ORG001&year=2025
```

**响应**：
```json
{
  "code": 200,
  "msg": "查询成功",
  "data": {
    "currentMetrics": {
      "avgScore": 85.6,
      "excellentRate": 0.25,
      "goodRate": 0.55,
      "passRate": 0.92
    },
    "childrenComparisons": [
      {
        "name": "第一教学组织",
        "avgScore": 88.5,
        "excellentRate": 0.30,
        "goodRate": 0.60,
        "passRate": 0.95
      },
      {
        "name": "第二教学组织",
        "avgScore": 82.3,
        "excellentRate": 0.22,
        "goodRate": 0.52,
        "passRate": 0.88
      },
      {
        "name": "第三教学组织",
        "avgScore": 86.7,
        "excellentRate": 0.28,
        "goodRate": 0.58,
        "passRate": 0.93
      }
    ],
    "yearlyTrend": {
      "years": ["2021", "2022", "2023", "2024", "2025"],
      "avgScores": [78.5, 80.2, 82.1, 84.3, 85.6],
      "excellentRates": [18.5, 20.3, 22.1, 24.0, 25.0],
      "goodRates": [48.2, 50.5, 52.8, 54.2, 55.0],
      "passRates": [88.5, 89.8, 90.5, 91.2, 92.0],
      "failRates": [11.5, 10.2, 9.5, 8.8, 8.0]
    }
  }
}
```

### 示例2：无下级单位的情况（最底层单位）

**请求**：
```
GET /api/assessment/dashboard/statistics?orgCode=ORG999&year=2025
```

**响应**：
```json
{
  "code": 200,
  "msg": "查询成功",
  "data": {
    "currentMetrics": {
      "avgScore": 78.3,
      "excellentRate": 0.18,
      "goodRate": 0.45,
      "passRate": 0.85
    },
    "childrenComparisons": [],
    "yearlyTrend": {
      "years": ["2021", "2022", "2023", "2024", "2025"],
      "avgScores": [72.1, 74.5, 76.2, 77.8, 78.3],
      "excellentRates": [12.5, 14.2, 15.8, 17.0, 18.0],
      "goodRates": [38.5, 40.2, 42.5, 44.0, 45.0],
      "passRates": [80.5, 82.0, 83.5, 84.2, 85.0],
      "failRates": [19.5, 18.0, 16.5, 15.8, 15.0]
    }
  }
}
```

---

## 数据计算说明

### 1. 如何计算 currentMetrics？

假设当前单位有以下考核数据：

| 被考核人 | 分数 | 评级 |
|----------|------|------|
| 张三 | 95 | 优秀 |
| 李四 | 88 | 良好 |
| 王五 | 92 | 优秀 |
| 赵六 | 76 | 及格 |
| 钱七 | 85 | 良好 |
| 孙八 | 58 | 未及格 |

**计算步骤**：

1. **avgScore（综合成绩）**：
   ```
   avgScore = (95 + 88 + 92 + 76 + 85 + 58) / 6 = 82.3
   ```

2. **excellentRate（优秀率）**：
   ```
   优秀人数 = 2（张三、王五）
   总人数 = 6
   excellentRate = 2 / 6 = 0.333
   ```

3. **goodRate（良好率，累计）**：
   ```
   优秀+良好人数 = 4（张三、王五、李四、钱七）
   goodRate = 4 / 6 = 0.667
   ```

4. **passRate（及格率，累计）**：
   ```
   及格以上人数 = 5（除了孙八）
   passRate = 5 / 6 = 0.833
   ```

### 2. 如何计算 childrenComparisons？

对**每个下级单位**，按照上述方法分别计算其 `avgScore`、`excellentRate`、`goodRate`、`passRate`，然后组装成数组。

### 3. 如何计算 yearlyTrend？

对当前单位，查询**最近5年**的历史考核数据，对每一年分别计算：
- `avgScores[i]`：该年度的平均分
- `excellentRates[i]`：该年度的优秀率（百分比，如 `25.0`）
- `goodRates[i]`：该年度的良好率（百分比，累计）
- `passRates[i]`：该年度的及格率（百分比，累计）
- `failRates[i]`：该年度的未及格率（百分比，`100 - passRates[i]`）

---

## 前端如何使用这些数据

### 1. 综合评定卡片
- 使用 `currentMetrics.avgScore` 计算评级：
  - `>= 90`：优秀
  - `>= 80`：良好
  - `>= 60`：及格
  - `< 60`：未及格

### 2. 综合成绩卡片
- 直接显示 `currentMetrics.avgScore.toFixed(1)`

### 3. 四级评价卡片
- 优秀率：`(currentMetrics.excellentRate * 100).toFixed(1) + '%'`
- 良好率：`((currentMetrics.goodRate - currentMetrics.excellentRate) * 100).toFixed(1) + '%'`
- 及格率：`((currentMetrics.passRate - currentMetrics.goodRate) * 100).toFixed(1) + '%'`
- 未及格率：`((1 - currentMetrics.passRate) * 100).toFixed(1) + '%'`

### 4. 下级单位成绩对比图
- X轴：`childrenComparisons.map(item => item.name)`
- Y轴：`childrenComparisons.map(item => item.avgScore)`

### 5. 下级单位四级评价对比图
- X轴：`childrenComparisons.map(item => item.name)`
- 4个系列（优秀/良好/及格/未及格）分别计算百分比

### 6. 当前单位占比饼图
- 优秀：`excellentRate * 100`
- 良好：`(goodRate - excellentRate) * 100`
- 及格：`(passRate - goodRate) * 100`
- 未及格：`(1 - passRate) * 100`

### 7. 年度趋势图
- X轴：`yearlyTrend.years`
- 5条折线：
  - 成绩：`yearlyTrend.avgScores`
  - 优秀率：`yearlyTrend.excellentRates`
  - 良好率：`yearlyTrend.goodRates`
  - 及格率：`yearlyTrend.passRates`
  - 未及格率：`yearlyTrend.failRates`

---

## 错误处理

### 单位不存在
```json
{
  "code": 404,
  "msg": "单位不存在",
  "data": null
}
```

### 年度数据不存在
```json
{
  "code": 200,
  "msg": "该年度暂无数据",
  "data": {
    "currentMetrics": {
      "avgScore": 0,
      "excellentRate": 0,
      "goodRate": 0,
      "passRate": 0
    },
    "childrenComparisons": [],
    "yearlyTrend": {
      "years": ["2021", "2022", "2023", "2024", "2025"],
      "avgScores": [0, 0, 0, 0, 0],
      "excellentRates": [0, 0, 0, 0, 0],
      "goodRates": [0, 0, 0, 0, 0],
      "passRates": [0, 0, 0, 0, 0],
      "failRates": [0, 0, 0, 0, 0]
    }
  }
}
```

---

## 性能优化建议

1. **数据缓存**：考核数据一般不会频繁变化，可以缓存结果（如Redis，TTL设置为1小时）
2. **分页限制**：`childrenComparisons` 最多返回8个，避免前端图表过于拥挤
3. **异步计算**：如果计算量大，可以考虑异步生成统计数据
4. **索引优化**：在 `org_code`、`year`、`score` 等字段上建立索引

---

## 总结

| 数据项 | 用途 | 数据量 | 关键字段 |
|--------|------|--------|----------|
| currentMetrics | 当前单位综合指标 | 1条 | avgScore, excellentRate, goodRate, passRate |
| childrenComparisons | 下级单位对比 | 0-8条 | name, avgScore, excellentRate, goodRate, passRate |
| yearlyTrend | 5年趋势分析 | 5年×6指标 | years[], avgScores[], excellentRates[], goodRates[], passRates[], failRates[] |

**注意**：
- `currentMetrics` 中的比例使用**小数**（0-1）
- `yearlyTrend` 中的比例使用**百分比**（0-100）
- 所有的 `goodRate` 和 `passRate` 都是**累计值**
